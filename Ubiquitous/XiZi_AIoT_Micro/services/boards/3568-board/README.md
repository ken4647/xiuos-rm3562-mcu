# RK3568开发板适配指南

## 1. RK3568处理器硬件架构

### 1.1 基本规格

RK3568是瑞芯微(Rockchip)推出的一款高性能、低功耗的处理器，主要面向AIoT和工业控制领域。其主要特点包括：

- **CPU架构**：四核Cortex-A55处理器核心，主频最高可达2.0GHz
- **指令集**：ARMv8-A 64位架构
- **制程工艺**：采用先进的制程工艺，提供优秀的性能功耗比
- **内存支持**：使用FLXC2004G-N1芯片，支持LPDDR4X内存，容量4GB，提供高速内存访问能力
- **Flash支持**：使用MWE3032CH7芯片，支持eMMC存储，容量32GB
- **应用场景**：适用于工业自动化控制、人机界面、中小型医疗分析器、电力等多种行业应用

### 1.2 主要外设接口

RK3568处理器拥有丰富的外设接口，包括：

- 双网口支持
- 双CAN总线接口
- 多路串口（最多支持5路）
- 其他丰富的工业控制接口

## 2. 微内核适配情况

### 2.1 编译环境配置

在微内核系统中，RK3568的编译环境配置如下：

- **交叉编译工具链**：`aarch64-none-elf-`
- **架构特性**：针对Cortex-A55进行了优化
- **编译标志**：包含必要的ARM64架构支持和优化选项

### 2.2 已实现的适配功能

目前，微内核与RK3568的适配已实现以下核心功能：

#### 2.2.1 系统调用接口

- 通过ARM64架构的`svc #0`指令实现系统调用
- 支持标准的系统调用参数传递和返回值处理
- 实现了`syscall()`和`syscall_ori()`两个系统调用函数接口

#### 2.2.2 串口通信

- 配置了UART基地址为`0xfeb50000`
- 实现了基本的串口初始化、发送(`putc`)和接收(`getc`)功能
- 支持标准的NS16550串口驱动协议

#### 2.2.3 硬件抽象层

- 提供了基础的硬件抽象接口
- 实现了必要的内存访问宏定义

## 3. 目录结构

`3568-board`目录包含以下主要文件：

```
3568-board/
├── Makefile        # 编译配置文件
├── arch_usyscall.c # 系统调用实现
├── libserial.c     # 串口通信库
└── stub.c          # 存根函数
```

### 3.1 文件功能说明

- **Makefile**：定义了RK3568的编译选项、工具链配置和依赖关系
- **arch_usyscall.c**：实现ARM64架构下的系统调用接口
- **libserial.c**：实现基于NS16550协议的串口通信功能
- **stub.c**：提供必要的存根函数支持

## 4. 适配细节

### 4.1 内存访问

- 使用了`out_le32()`和`in_le32()`宏进行内存映射IO操作
- 支持按位移的寄存器访问方式

### 4.2 UART配置

- UART基地址：`0xfeb50000`
- 支持FIFO使能、收发缓冲区重置等功能
- 默认配置为8位数据位、无校验、1位停止位(8N1)

## 5. 使用说明

### 5.1 编译方法

在编译微内核应用时，指定`BOARD=3568`参数即可使用RK3568的适配配置：

```bash
make BOARD=3568
```

### 5.2 调试支持

- 串口输出可用于调试信息的打印
- 支持GDB调试符号

## 6. hardkernel适配详情

hardkernel是微内核系统中负责硬件抽象和底层驱动的核心组件，为RK3568提供了全面的硬件支持。

### 6.1 适配目录结构

hardkernel中与RK3568相关的适配文件主要分布在以下目录：

```
hardkernel/
├── arch/arm/armv8-a/cortex-a55/preboot_for_3568/    # 引导和初始化
├── uart/arm/armv8-a/cortex-a55/uart_io_for_3568/   # UART驱动
├── clock/arm/armv8-a/cortex-a55/3568/              # 时钟配置
├── intr/arm/armv8-a/cortex-a55/3568/               # 中断处理
└── mmu/arm/armv8-a/cortex-a55/3568/                # 内存管理单元配置
```

### 6.2 核心适配功能

#### 6.2.1 引导初始化

- 实现在`boot.S`中，包含EL2到EL1的切换
- 配置CPU核心、栈初始化和异常处理设置
- 支持多核心启动，区分主CPU和从CPU的初始化路径

**uboot启动XiZi_AIoT微内核操作系统的过程如下：**

1. **CPU0启动阶段**：
   - uboot首先启动CPU0（主核心）
   - 从TF卡加载XiZi微内核到内存地址`0x10000000`
   - XiZi微内核接管CPU0控制权，开始初始化过程

2. **内核初始化阶段**：
   - XiZi微内核继续初始化CPU0，主要完成hardkernel（硬件抽象层）初始化
   - 随后初始化softkernel（核心功能层），建立系统基础架构

3. **从核启动阶段**：
   - XiZi微内核通过PSCI（电源状态协调接口）协议启动从核
   - 从核程序起点为uboot存放位置
   - 核心启动地址`0X20000`是通过`relocadrr-reloc off`计算得出的
   - uboot负责从核的初始启动，随后将控制权交给微内核

4. **多核运行状态**：
   - 完成初始化后，所有核心进入微内核调度管理，实现多核并行运行
   - 通过这种方式，充分利用RK3568的四核处理能力

以下图片展示了RK3568 XiZi_AIoT成功启动四核的运行状态：


![成功启动图](./img/RK3568SMP4.png)

该图片直观地展示了RK3568处理器的四个Cortex-A55核心同时运行的状态，充分体现了微内核系统在多核心处理能力上的出色表现。成功的多核启动确保了系统能够充分利用处理器资源，为AIoT应用提供强大的计算支持和响应能力。

#### 6.2.2 UART驱动

- 基于标准NS16550协议实现
- UART基地址配置为`0xfeb50000`
- 实现了基本的串口初始化(`uartinit`)、发送(`uartputc`)和接收(`uartgetc`)功能
- 支持波特率配置（默认配置为高速波特率）

#### 6.2.3 时钟管理

- 基于ARM通用定时器实现
- 配置了1ms间隔的定时器中断
- 实现了时钟初始化、使能、禁用和重载功能
- 提供时间戳和秒级时间获取接口

#### 6.2.4 中断控制

- 支持GICv3中断控制器
- 实现了异常处理和陷阱机制
- 包含中断号定义和中断处理函数

#### 6.2.5 内存管理

- 提供内存布局定义(`memlayout.h`)
- 支持虚拟内存空间管理
- 实现了页表操作和内存属性配置

## 7. softkernel适配详情

softkernel是微内核系统的核心实现层，提供了平台无关的系统功能支持。

### 7.1 适配特点

- **通用微内核架构**：softkernel不直接包含硬件特定代码，采用平台无关的设计
- **资源标签系统**：通过资源标签机制与hardkernel进行交互，实现硬件抽象隔离
- **模块化设计**：包含任务管理、内存管理、IPC通信等核心功能模块

### 7.2 核心功能

#### 7.2.1 任务管理
- 实现任务创建、调度和状态管理
- 支持多任务并发执行

#### 7.2.2 内存管理
- 提供伙伴系统和对象分配器
- 支持内存空间隔离和保护

#### 7.2.3 系统调用
- 提供标准的系统调用接口
- 实现系统调用分发和处理

#### 7.2.4 资源管理
- 通过资源标签系统管理硬件资源访问权限
- 实现资源的创建、获取和释放机制

### 7.3 与hardkernel的交互

softkernel通过以下方式与hardkernel进行交互：
- 通过资源标签(`TraceTag`)获取硬件驱动服务
- 调用hardkernel提供的初始化函数设置系统环境
- 依赖hardkernel提供的底层硬件访问接口

## 8. 后续优化方向

- 完善更多外设的驱动支持
- 优化性能和功耗
- 添加更多平台特定功能
- 增强多核心调度能力
- 完善内存管理和缓存优化

---

*本适配指南提供了RK3568处理器与微内核系统的完整适配信息，包括hardkernel和softkernel的详细适配情况，可根据实际应用需求进行进一步的开发和优化。*